require 'prof/environment/cloud_foundry'

require 'helpers/utilities'
require 'support/redis_service_broker'
require 'support/redis_service_client_builder'

class FilteredStderr < StringIO
  def write value
    if value.include? "Object#timeout is deprecated"
      return
    end

    if value == "\n"
      return
    end

    STDERR.write value
  end
end

module Helpers
  def broker_ssh
    BoshSSH.new('cf-redis-broker', 0).with_gateway(
      'pcf.pikachu.gcp.london.cf-app.com',
      'ubuntu',
      '/tmp/pikachu.pem',
    )
  end

  class BoshSSH
    def initialize job, node
      @job = job
      @node = node
      @bosh = Bosh.new(
        ENV['BOSH_TARGET'],
        ENV['BOSH_USERNAME'],
        ENV['BOSH_PASSWORD'],
        '/tmp/pikachu.cert',
        'cf-redis'
      )
    end

    def exec! command
      @bosh.ssh(
        @job,
        @node,
        command,
        gw_user: 'ubuntu',
        gw_host: 'pcf.pikachu.gcp.london.cf-app.com',
        gw_private_key: '/tmp/pikachu.pem',
      )
    end

  end

  def broker_ssh
    BoshSSH.new 'cf-redis-broker', 0
  end

  def node_ssh
    BoshSSH.new 'dedicated-node', 0
  end

  module Environment
    fail "Must specify BOSH_MANIFEST environment variable" unless ENV.key?('BOSH_MANIFEST')

    def environment
      @environment ||= begin
        options = {
          bosh_manifest_path: ENV.fetch('BOSH_MANIFEST'),
          bosh_service_broker_job_name: 'cf-redis-broker'
        }
        options[:bosh_target]          = ENV['BOSH_TARGET']                 if ENV.key?('BOSH_TARGET')
        options[:bosh_username]        = ENV['BOSH_USERNAME']               if ENV.key?('BOSH_USERNAME')
        options[:bosh_password]        = ENV['BOSH_PASSWORD']               if ENV.key?('BOSH_PASSWORD')
        # options[:ssh_gateway_host]     = 'pcf.pikachu.gcp.london.cf-app.com' if ENV.key?('BOSH_TARGET')
        # options[:ssh_gateway_username] = 'ubuntu'                           if ENV.key?('BOSH_TARGET')
        # options[:ssh_gateway_password] = 'c1oudc0w'                         if ENV.key?('BOSH_TARGET')

        options[:use_proxy]            = ENV['USE_PROXY'] == 'true'
        Prof::Environment::CloudFoundry.new(options)
      end
    end

    def redis_service_broker
      Support::RedisServiceBroker.new(service_broker)
    end

    def service_broker
      environment.service_broker
    end

    def bosh_manifest
      environment.bosh_manifest
    end

    def bosh_director
      environment.bosh_director
    end

    # net-ssh makes a deprecated call to `timeout`. We ignore these messages
    # because they pollute logs.
    # After using the filtered stderr we ensure to reassign the original stderr
    # stream.
    def ssh_gateway
      gateway = environment.ssh_gateway
      def gateway.execute_on(*args, &block)
        begin
          original_stderr = $stderr
          $stderr = FilteredStderr.new
          super
        ensure
          $stderr = original_stderr
        end
      end

      def gateway.scp_to(*args, &block)
        begin
          original_stderr = $stderr
          $stderr = FilteredStderr.new
          super
        ensure
          $stderr = original_stderr
        end
      end

      gateway
    end

    def broker_host
      bosh_manifest.job('cf-redis-broker').static_ips.first
    end

    def node_hosts
      bosh_manifest.job('dedicated-node').static_ips
    end

    def broker_backend_port
      bosh_manifest.property('redis').fetch('broker').fetch('backend_port')
    end

    def agent_backend_port
      bosh_manifest.property('redis').fetch('agent').fetch('backend_port')
    end

    def service_client_builder(binding)
      Support::RedisServiceClientBuilder.new(
        ssh_gateway:    ssh_gateway,
        save_command:   bosh_manifest.property('redis.save_command'),
        config_command: bosh_manifest.property('redis.config_command')
      ).build(binding)
    end
  end
end
